<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<body th:fragment=flow_List>
<meta th:include="/Macro/csrfTokeHeadMacro :: csrfTokeHeadMacro"/>
<style type="text/css">
    /*人为制造一个占据整个屏幕的Div,其透明度为0.7且z-index为9999使之前的页面被压在底层无法点击*/
    .fullScreenList {
        position: fixed;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        opacity: 0.7;
        background-color: black;
        z-index: 9999;
        text-align: center;
    }
</style>
<script th:src="@{/charisma/js/layer/layer.js}"></script>
<!-- content starts -->
<div class="wrapper" style="margin: 20px;">

    <!-- Media datatable -->
    <div class="widget">
        <div class="navbar">
            <div class="navbar-inner">
                <h6>Flow List</h6>
            </div>
        </div>
        <div class="navbar">
            <a class='btn' href='javascript:void(0);' onclick="newPath();" style='background-color: #C0C0C0;border: 1px solid;color: #080808;' title="create flow">
                <i class='icon-plus-sign icon-white'></i>
            </a>
        </div>
        <div class="table-overflow">
            <table class="table table-striped table-bordered table-checks media-table">
                <thead>
                <tr>
                    <th style="display: none">sort</th>
                    <th style="display: none">flowId</th>
                    <th>name</th>
                    <th>description</th>
                    <th>createTime</th>
                    <th class="actions-column">Actions</th>
                    <th style="display: none">driverMemory</th>
                    <th style="display: none">executorNumber</th>
                    <th style="display: none">executorMemory</th>
                    <th style="display: none">executorCores</th>
                </tr>
                </thead>
                <tbody th:unless="${appInfo}">
                </tbody>
                <tbody th:if="${appInfo}">
                <tr th:each='list:${appInfo}'>
                    <td style="display: none" th:text="${listStat.index}"></td>
                    <td style="display: none" th:text="${list.id}"></td>
                    <td class="center" th:text="${list.name}"></td>
                    <td class="center" th:text="${list.description}"></td>
                    <td th:text="${#dates.format(list.crtDttm, 'yyyy-MM-dd HH:mm:ss')}"></td>
                    <td style="display: none" class="center"
                        th:text="${list.driverMemory}?${list.driverMemory}:'1g'"></td>
                    <td style="display: none" class="center"
                        th:text="${list.executorNumber}?${list.executorNumber}:'1'"></td>
                    <td style="display: none" class="center"
                        th:text="${list.executorMemory}?${list.executorMemory}:'1g'"></td>
                    <td style="display: none" class="center"
                        th:text="${list.executorCores}?${list.executorCores}:'1'"></td>
                    <td class="center" style="white-space: nowrap;">
                        <a class="btn"
                           th:href="'/piflow-web/grapheditor/home?load='+${list.id}+''"
                           target="_blank" style="background-color: #C0C0C0;border: 1px solid;color: #6b5555;">
                            <i class="icon-share-alt icon-white"></i>
                        </a>
                        <a class="btn" href="javascript:void(0);"
                           style="background-color: #C0C0C0;border: 1px solid;color: #6b5555;"
                           th:onclick="'javascript:update(\''+${list.id}+'\',\''+${list.name}+'\',\''+${list.description}+'\',\''+${list.driverMemory}+'\',\''+${list.executorNumber}+'\',\''+${list.executorMemory}+'\',\''+${list.executorCores}+'\');'"
                           title="update flow">
                            <i class="icon-edit icon-white"></i>
                        </a>
                        <a class="btn" href="javascript:void(0);"
                           style="background-color: #C0C0C0;border: 1px solid;color: #6b5555;"
                           th:onclick="'javascript:runFlows(\''+${list.id}+'\');'">
                            <i class="icon-play icon-white"></i>
                        </a>
                       <!-- <a class="btn" href="javascript:void(0);"
                           style="background-color: #C0C0C0;border: 1px solid;color: #6b5555;"
                           th:onclick="'javascript:stopFlow(\''+${list.id}+'\');'">
                            <i class="icon-stop icon-white"></i>
                        </a>-->
                        <a class="btn" href="javascript:void(0);"
                           style="background-color: #C0C0C0;border: 1px solid;color: #6b5555;"
                           th:onclick="'javascript:deleteFlow(\''+${list.id}+'\',\''+${list.name}+'\');'">
                            <i class="icon-trash icon-white"></i>
                        </a>
                        <a class="btn" href="javascript:void(0);"
                           style="background-color: #C0C0C0;border: 1px solid;color: #6b5555;"
                           th:onclick="'javascript:saveTableTemplate(\''+${list.id}+'\',\''+${list.name}+'\');'">
                            <i class="icon-check icon-white"></i>
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- /media datatable -->
</div>
<!-- content ends -->
<!-- Modal Checkpoint -->
<!-- Modal Checkpoint -->
<div class="modal" id="checkpointListShow" aria-labelledby="myModalLabel" data-backdrop="static"
     style="z-index: 10000; display: none">
    <div id="modalDialogPort" class="modal-dialog" role="document">
        <div class="modal-content" style="width: 100%;  top: 77px;">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabelPort">CHOOSE CHECKPOINT WINDOWS</h4>
            </div>
            <div id="checkpointListContent" class="modal-body">
                Did not find checkpoint information
                <input type="checkbox" value="">
            </div>
            <div class="modal-footer">
                <button id="runProcessBtn" type="button" class="btn btn-default">Run</button>
                <button id="stopProcessBtn" type="button" class="btn btn-default">Cancel</button>
            </div>
        </div>
    </div>
</div>
<div id='fullScreenList' class="fullScreenList" style="display: none;">
    <div style="margin-top: 15%;">
        <p>
            <img th:src="@{/img/fullScreen.gif}" alt="">
        </p>
    </div>
    `
</div>

<div style="display: none;" id="SubmitPage">
    <form class="layui-form" action="">
        <div class="layui-form-item">
            <label class="layui-form-label">flowName</label>
            <div class="layui-input-block">
                <input type="hidden" id="flowId"/>
                <input id="flowName" placeholder="please input flowName..." autocomplete="off" class="layui-input"
                       style="width: 400px;margin-left: 20px;">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">description</label>
            <div class="layui-input-block">
                <textarea id="description" placeholder="please input description..." class="layui-textarea"
                          style="width: 400px;margin-left: 20px;"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">driverMemory</label>
            <div class="layui-input-block">
                <input id="driverMemory" autocomplete="off" class="layui-input" style="width: 400px;margin-left: 20px;"
                       value="1g">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">executorNumber</label>
            <div class="layui-input-block">
                <input id="executorNumber" autocomplete="off" class="layui-input"
                       style="width: 400px;margin-left: 20px;" value="1">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">executorMemory</label>
            <div class="layui-input-block">
                <input id="executorMemory" autocomplete="off" class="layui-input"
                       style="width: 400px;margin-left: 20px;" value="1g">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">executorCores</label>
            <div class="layui-input-block">
                <input id="executorCores" autocomplete="off" class="layui-input" style="width: 400px;margin-left: 20px;"
                       value="1">
            </div>
        </div>
        <div class="layui-form-item" style="text-align: center;margin-right: 90px;">
            <div class="layui-input-block">
                <button type="button" class="layui-btn layui-btn-primary" onclick='saveFlow()' id="buttonFlow">提交
                </button>
            </div>
        </div>
    </form>
</div>

<script th:include="/Macro/csrfTokeHeadMacroScript :: csrfTokeHeadMacroScript"/>
<script th:inline="javascript">
    function loadPostRight(url) {
        $.ajax({
            type: "POST",//为get请求
            url: url,
            data: {},
            success: function (data) {//请求成功之后的操作
                //console.log("success");
                $('#content').html(data);
            }
        });
    }

    function loadGetRight(url) {
        window.location.href = url;
    }

    function initAll(url) {
        window.location.href = url;
    }

    //@ sourceURL=table.js
</script>
<script th:inline="javascript">
    function newPath() {
        $("#buttonFlow").attr("onclick", "");
        $("#buttonFlow").attr("onclick", "saveFlow()");
        $("#flowId").val("");
        $("#flowName").val("");
        $("#description").val("");
        $("#driverMemory").val('1g');
        $("#executorNumber").val('1');
        $("#executorMemory").val('1g');
        $("#executorCores").val('1');
        layer.open({
            type: 1,
            title: 'create flow',
            shadeClose: true,
            closeBtn: 1,
            shift: 7,
            area: ['580px', '520px'], //宽高
            skin: 'layui-layer-rim', //加上边框
            content: $("#SubmitPage")
        });
    }

    function update(id, updateName, updateDescription, driverMemory, executorNumber, executorMemory, executorCores) {
        $("#buttonFlow").attr("onclick", "");
        $("#buttonFlow").attr("onclick", "updateFlow()");
        $("#flowId").val(id);
        $("#flowName").val(updateName);
        $("#description").val(updateDescription);
        $("#driverMemory").val(driverMemory);
        $("#executorNumber").val(executorNumber);
        $("#executorMemory").val(executorMemory);
        $("#executorCores").val(executorCores);
        layer.open({
            type: 1,
            title: 'update flow',
            shadeClose: true,
            closeBtn: false,
            shift: 7,
            closeBtn: 1,
            area: ['580px', '520px'], //宽高
            skin: 'layui-layer-rim', //加上边框
            content: $("#SubmitPage")
        });
    }

    function saveFlow() {
        var flowName = $("#flowName").val();
        var description = $("#description").val();
        var driverMemory = $("#driverMemory").val();
        var executorNumber = $("#executorNumber").val();
        var executorMemory = $("#executorMemory").val();
        var executorCores = $("#executorCores").val();
        if (checkFlowInput(flowName, description, driverMemory, executorNumber, executorMemory, executorCores))
            $.ajax({
                cache: true,//保留缓存数据
                type: "get",//为post请求
                url: "/piflow-web/flow/saveFlowInfo",//这是我在后台接受数据的文件名
                data: {
                    name: flowName,
                    description: description,
                    driverMemory: driverMemory,
                    executorNumber: executorNumber,
                    executorMemory: executorMemory,
                    executorCores: executorCores
                },
                async: false,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
                error: function (request) {//请求失败之后的操作
                    layer.closeAll('page');
                    layer.msg('creation failed ', {icon: 2, shade: 0, time: 2000}, function () {
                    });
                    return;
                },
                success: function (data) {//请求成功之后的操作
                    layer.closeAll('page');
                    var dataMap = JSON.parse(data);
                    if ("1" === dataMap.code) {
                        layer.msg('create success ', {icon: 1, shade: 0, time: 2000}, function () {
                            var tempwindow = window.open('_blank');
                            tempwindow.location = "/piflow-web/grapheditor/home?load=" + dataMap.flowId;
                        });
                    } else {
                        layer.msg('creation failed', {icon: 2, shade: 0, time: 2000}, function () {
                        });
                    }
                }
            });
    }

    function updateFlow() {
        var id = $("#flowId").val();
        var flowName = $("#flowName").val();
        var description = $("#description").val();
        var driverMemory = $("#driverMemory").val();
        var executorNumber = $("#executorNumber").val();
        var executorMemory = $("#executorMemory").val();
        var executorCores = $("#executorCores").val();
        if (checkFlowInput(flowName, description, driverMemory, executorNumber, executorMemory, executorCores))
            $.ajax({
                cache: true,//保留缓存数据
                type: "get",//为post请求
                url: "/piflow-web/flow/updateFlowInfo",//这是我在后台接受数据的文件名
                data: {
                    id: id,
                    name: flowName,
                    description: description,
                    driverMemory: driverMemory,
                    executorNumber: executorNumber,
                    executorMemory: executorMemory,
                    executorCores: executorCores
                },
                async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
                error: function (request) {//请求失败之后的操作
                    layer.closeAll('page');
                    layer.msg('update failed ', {icon: 2, shade: 0, time: 2000}, function () {
                        window.location.reload();
                    });
                    return;
                },
                success: function (data) {//请求成功之后的操作
                    if (data > 0) {
                        layer.closeAll('page');
                        layer.msg('update success', {icon: 1, shade: 0, time: 2000}, function () {
                            location.reload();
                        });
                    }
                }
            });
    }

    //运行
    function runFlows(loadId) {
        $('#fullScreenList').show();
        $.ajax({
            cache: true,//保留缓存数据
            type: "get",//为post请求
            url: "/piflow-web/flow/runFlow",//这是我在后台接受数据的文件名
            //data:$('#loginForm').serialize(),//将该表单序列化
            data: {flowId: loadId},
            async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
            error: function (request) {//请求失败之后的操作
                $('#fullScreenList').hide();
                alert("reload fail");
                return;
            },
            success: function (data) {//请求成功之后的操作
                var dataMap = JSON.parse(data);
                if ('0' !== dataMap.code) {
                    $('#fullScreenList').hide();
                    layer.msg(dataMap.errMsg, {icon: 1, shade: 0, time: 2000}, function () {
                        //启动成功后跳转至监控页面
                        var tempwindow = window.open('_blank');
                        tempwindow.location = "/piflow-web/process/getProcessById?processId=" + dataMap.processId;
                    });
                } else {
                    $('#fullScreenList').hide();
                    layer.msg(dataMap.errMsg, {icon: 2, shade: 0, time: 2000}, function () {
                        location.reload();
                    });
                }

            }
        });
    }

    //停止
    function stopFlow(loadId) {
        $('#fullScreenList').show();
        $.ajax({
            cache: true,//保留缓存数据
            type: "get",//为post请求
            url: "/piflow-web/flow/stopFlow",//这是我在后台接受数据的文件名
            //data:$('#loginForm').serialize(),//将该表单序列化
            data: {flowId: loadId},
            async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
            error: function (request) {//请求失败之后的操作
                $('#fullScreenList').hide();
                alert("reload fail");
                return;
            },
            success: function (data) {//请求成功之后的操作
                var dataMap = JSON.parse(data);
                if ('0' !== dataMap.code) {
                    $('#fullScreenList').hide();
                    layer.msg(dataMap.errMsg, {icon: 1, shade: 0, time: 2000}, function () {
                        location.reload();
                    });
                    return;
                } else {
                    $('#fullScreenList').hide();
                    layer.msg(dataMap.errMsg, {icon: 2, shade: 0, time: 2000}, function () {
                        location.reload();
                    });
                }
            }
        });
    }

    function tableRow() {
        var arrayObj = new Array();
        var table = $("table tr").find("td:eq(1)");
        var state = $("table tr").find("td:eq(7)");
        for (var i = 0; i < table.length; i++) {
            if (table[i].innerHTML != "") {
                if (state[i].innerHTML != "No state" && state[i].innerHTML == "STARTED") {
                    arrayObj.push(table[i].innerHTML);
                }
            }
        }
        if (arrayObj.length == 0) {
            clearInterval(c);
            return;
        }
        $.ajax({
            cache: true,
            type: "get",
            url: "/piflow-web/flowInfoDb/list",
            data: {content: arrayObj},
            async: true,
            traditional: true,
            error: function (request) {
                console.log("error");
                return;
            },
            success: function (data) {
                if (null != data) {
                    var dataMap = JSON.parse(data);
                    if ('0' !== dataMap.code) {
                        document.getElementById("" + dataMap.id + "").value = dataMap.progress;
                        document.getElementById("" + dataMap.id + "Info").innerHTML = "进度" + dataMap.progress + "%";
                        document.getElementById("" + dataMap.id + "state").innerHTML = dataMap.state;
                        if (dataMap.endTime && "" !== dataMap.startTime) {
                            document.getElementById("" + dataMap.id + "startTime").innerHTML = dataMap.startTime;
                            document.getElementById("" + dataMap.id + "endTime").innerHTML = dataMap.endTime;
                        }
                    }
                }
            }
        });
    }

    $(document).ready(function () {
        c = window.setInterval("tableRow()", 5000);
    });

    function deleteFlow(id, name) {
        layer.confirm("Are you sure to delete '" + name + "' ?", {
            btn: ['confirm', 'cancel'] //按钮
            , title: 'Confirmation prompt'
        }, function () {
            $.ajax({
                cache: true,//保留缓存数据
                type: "get",//为post请求
                url: "/piflow-web/flow/deleteFlow",//这是我在后台接受数据的文件名
                data: {id: id},
                async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
                error: function (request) {//请求失败之后的操作
                    return;
                },
                success: function (data) {//请求成功之后的操作
                    if (data > 0) {
                        layer.msg('Delete Success', {icon: 1, shade: 0, time: 2000}, function () {
                            location.reload();
                        });
                    } else {
                        layer.msg('Delete failed', {icon: 2, shade: 0, time: 2000}, function () {
                        });
                    }
                }
            });
        }, function () {
        });
    }

    function checkFlowInput(flowName, description, driverMemory, executorNumber, executorMemory, executorCores) {
        if (flowName == '') {
            layer.msg('flowName Can not be empty', {icon: 2, shade: 0, time: 2000});
            document.getElementById('flowName').focus();
            return false;
        }

        /*  if (description == '') {
             layer.msg('description不能为空！', {icon: 2, shade: 0, time: 2000});
             document.getElementById('description').focus();
             return false;
         } */
        if (driverMemory == '') {
            layer.msg('driverMemory Can not be empty', {icon: 2, shade: 0, time: 2000});
            document.getElementById('driverMemory').focus();
            return false;
        }
        if (executorNumber == '') {
            layer.msg('executorNumber Can not be empty', {icon: 2, shade: 0, time: 2000});
            document.getElementById('executorNumber').focus();
            return false;
        }
        if (executorMemory == '') {
            layer.msg('executorMemory Can not be empty', {icon: 2, shade: 0, time: 2000});
            document.getElementById('executorMemory').focus();
            return false;
        }
        if (executorCores == '') {
            layer.msg('executorCores Can not be empty', {icon: 2, shade: 0, time: 2000});
            document.getElementById('executorCores').focus();
            return false;
        }
        return true;
    }

    function saveTableTemplate(id, name) {
        layer.prompt({
            title: 'please enter the template name',
            formType: 0,
            btn: ['submit', 'cancel']
        }, function (text, index) {
            layer.close(index);
            $.ajax({
                cache: true,//保留缓存数据
                type: "get",//为post请求
                url: "/piflow-web/template/saveTemplate",//这是我在后台接受数据的文件名
                data: {load: id, name: text},
                async: true,
                error: function (request) {//请求失败之后的操作
                    console.log(" save template error");
                    return;
                },
                success: function (data) {//请求成功之后的操作
                    var dataMap = JSON.parse(data);
                    if (0 !== dataMap.code) {
                        layer.msg(dataMap.errMsg, {icon: 1, shade: 0, time: 2000}, function () {
                        });
                    } else {
                        layer.msg(dataMap.errMsg, {icon: 2, shade: 0, time: 2000}, function () {
                        });
                    }
                }
            });
        });
    }

    //@ sourceURL=table_right.js
</script>
</body>
</html>
