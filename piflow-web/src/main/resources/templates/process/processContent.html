<!--[if IE]>
<meta http-equiv="X-UA-Compatible" content="IE=5,IE=9"><![endif]-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ProcessContent</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/grapheditor/styles/grapheditor.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/charisma/css/bootstrap.min.css}">
    <style type="text/css">
        /*人为制造一个占据整个屏幕的Div,其透明度为0.7且z-index为9999使之前的页面被压在底层无法点击*/
        .fullScreen {
            position: fixed;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            opacity: 0.7;
            background-color: black;
            z-index: 9999;
            text-align: center;
        }
    </style>
</head>
<body class="geEditor">
<div style="position: fixed; z-index: 779;text-align: right;right: 27%;top: 10px;">
			<span>
				进度：<span id="progress" th:text="${percentage} + '%'"></span>
			</span>
    <input id="startFlow" type="button" onclick="getCheckpoint()" value="运行"/>
    <input id="stopFlow" type="button" onclick="stopProcess()" value="停止"/>
    <input type="button" class="btn-primary" data-toggle="modal" onclick="getLogUrl()" data-target="#myModal"
           value="日志"/>
</div>
<div id="processContent" style="overflow: auto; width: 75%; height: 100%; position: fixed;z-index: 778;">
    <div class="geBackgroundPage"
         style="position: absolute;border-width: 1px;overflow: hidden;width: 2391px;height: 2167px;border-color: rgb(202, 202, 202);border-style: solid;background-color: rgb(255, 255, 255);background-image: url(&quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSAwIDEwIEwgNDAgMTAgTSAxMCAwIEwgMTAgNDAgTSAwIDIwIEwgNDAgMjAgTSAyMCAwIEwgMjAgNDAgTSAwIDMwIEwgNDAgMzAgTSAzMCAwIEwgMzAgNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2UwZTBlMCIgb3BhY2l0eT0iMC4yIiBzdHJva2Utd2lkdGg9IjEiLz48cGF0aCBkPSJNIDQwIDAgTCAwIDAgMCA0MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTBlMGUwIiBzdHJva2Utd2lkdGg9IjEiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JpZCkiLz48L3N2Zz4=&quot;);background-position: -1px -1px;"></div>
</div>

<div id="processLeft" class="geSidebarContainer"
     style="right: 0px;background-color: whitesmoke;font-size: 12px;width: 25%;height: 100%;">
    Loading.....
</div>
<!-- Modal Checkpoint -->
<div class="modal" id="checkpointShow" aria-labelledby="myModalLabel" data-backdrop="static">
    <div id="modalDialogPort" class="modal-dialog" role="document">
        <div class="modal-content" style="width: 100%;  top: 77px;">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabelPort">CHOOSE CHECKPOINT WINDOWS</h4>
            </div>
            <div id="checkpointContent" class="modal-body">
                没有查询到checkpoint信息
                <input type="checkbox" value="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" onclick="runProcess(true)">Run</button>
                <button type="button" class="btn btn-default" onclick="runProcess(false)">Cancel</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal 日志 -->
<div class="modal" id="myModal" aria-labelledby="myModalLabel" data-backdrop="static">
    <div id="modalDialog" class="modal-dialog" role="document">
        <div class="modal-content" style="width: 200%; left: -290px; top: 77px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">LOG WINDOWS</h4>
            </div>
            <div class="modal-body">
                <!-- <div id="logTitle">加载中</div> -->
                <table border="1" style="width: 100%; height: 100%;">
                    <tr style="height: 90%;">
                        <td id="customContent">
                            loading.....
                        </td>
                    </tr>
                </table>
                <input type="button" onclick="changeUrl(1)" value="stdout">
                <input type="button" onclick="changeUrl(2)" value="stderr">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<div id='fullScreen' class="fullScreen" style="display: none;">
    <div style="margin-top: 15%;">
        <p>
            <img th:src="@{/img/fullScreen.gif}" alt="">
        </p>
    </div>
    `
</div>
<script type="text/javascript" th:src="@{/grapheditor/js/jquery.min.js}"></script>
<script type="text/javascript" th:src="@{/charisma/js/jquery-ui.min.js}"></script>
<script type="text/javascript" th:src="@{/charisma/js/bootstrap.min.js}"></script>
<script th:inline="javascript">
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    var fullScreen = $('#fullScreen');
    var startFlow = $('#startFlow');
    var stopFlow = $('#stopFlow');
    var processContent = $('#processContent');
    var checkpointShow = $('#checkpointShow');
    var xmlDate = [[${xmlDate}]];
    var processId = [[${processId}]];
    var parentProcessId = [[${parentProcessId}]];
    var pID = [[${pID}]];
    var appId = [[${appId}]];
    var processState = [[${processState}]];
    var stdoutLog = [[${stdoutLog}]];
    var stderrLog = [[${stderrLog}]];
    $(document).ajaxSend(function (e, xhr, options) {
        xhr.setRequestHeader(header, token);
    });
    (function () {
        if (processContent) {
            if (xmlDate) {
                processContent.append(xmlDate);
            } else {
                processContent.prepend('<div style="position: fixed;z-index: 779;"><h1>视图丢失</h1></div>');
            }
        }
        if (startFlow) {
            if ("STARTED" === processState) {
                startFlow.hide();
                stopFlow.show();
                timer = window.setInterval("processMonitoring(appId)", 5000);
            } else {
                startFlow.show();
                stopFlow.hide();
            }
        }
        var processStopVoListInit = [[${processStopVoListInit}]];
        if (processStopVoListInit && '' != processStopVoListInit) {
            for (var i = 0; i < processStopVoListInit.length; i++) {
                var processStopVoInit = processStopVoListInit[i];
                monitor(processStopVoInit.pageId, processStopVoInit.state);
            }
        }
        queryProcess(processId);
        $("#modalDialog").draggable();//为模态对话框添加拖拽
        $("#myModal").css("overflow", "hidden");//禁止模态对话框的半透明背景滚动
    })();

    function clickFormation(x, y, width, height, pageId) {
        if (x && y && width && height && pageId) {
            var selectedRectShow = $('#selectedRectShow');
            if (selectedRectShow) {
                selectedRectShow.attr('x', x).attr('y', y).attr('width', width).attr('height', height);
            }
            queryProcessStop(processId, pageId);
        } else {
            alert("必要位置参数没有获得");
        }
    }

    function queryProcess(processId) {
        $.ajax({
            cache: true,//保留缓存数据
            type: "POST",//为post请求
            url: "/piflow-web/process/queryProcess",//这是我在后台接受数据的文件名
            //data:$('#loginForm').serialize(),//将该表单序列化
            data: {
                processId: processId
            },
            async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
            error: function (request) {//请求失败之后的操作
                console.log("fail");
                return;
            },
            success: function (data) {//请求成功之后的操作
                // console.log(data);
                $('#processLeft').html(data)
            }
        });
    }

    function queryProcessStop(processId, pageId) {
        $.ajax({
            cache: true,//保留缓存数据
            type: "POST",//为post请求
            url: "/piflow-web/process/queryProcessStop",//这是我在后台接受数据的文件名
            //data:$('#loginForm').serialize(),//将该表单序列化
            data: {
                processId: processId,
                pageId: pageId
            },
            async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
            error: function (request) {//请求失败之后的操作
                console.log("fail");
                return;
            },
            success: function (data) {//请求成功之后的操作
                // console.log(data);
                $('#processLeft').html(data)
                $('#selectedRectShow').show();
            }
        });
    }

    //获取Checkpoint点
    function getCheckpoint() {
        fullScreen.show();
        $.ajax({
            cache: true,//保留缓存数据
            type: "POST",//为post请求
            url: "/piflow-web/process/getCheckpoint",//这是我在后台接受数据的文件名
            //data:$('#loginForm').serialize(),//将该表单序列化
            data: {
                pID: pID,
                parentProcessId:parentProcessId
            },
            async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
            error: function (request) {//请求失败之后的操作
                startFlow.show();
                alert("请求失败");
                fullScreen.hide();
                checkpointShow.modal('hide');
                return;
            },
            success: function (data) {//请求成功之后的操作
                //console.log("success");
                $('#checkpointContent').html(data);
                if ($('#checkpointsIsNull').val()) {
                    alert("没有查询到");
                    checkpointShow.modal('hide');
                    runProcess(true);
                } else {
                    checkpointShow.modal('show');
                }
                startFlow.show();
                fullScreen.hide();
            }
        });

    }

    //运行
    function runProcess(flag) {
        if (!flag) {
            checkpointShow.modal('hide');
            return;
        }
        startFlow.hide();
        var checkpointStr = '';
        $('#checkpointContent').find("input[type='checkbox']:checked").each(function () {
            if ('' !== checkpointStr) {
                checkpointStr = (checkpointStr + ',');
            }
            checkpointStr = (checkpointStr + $(this).val());
        });
        fullScreen.show();
        $.ajax({
            cache: true,//保留缓存数据
            type: "POST",//为post请求
            url: "/piflow-web/process/runProcess",//这是我在后台接受数据的文件名
            //data:$('#loginForm').serialize(),//将该表单序列化
            data: {
                id: processId,
                checkpointStr: checkpointStr
            },
            async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
            error: function (request) {//请求失败之后的操作
                startFlow.show();
                alert("请求失败");
                fullScreen.hide();
                return;
            },
            success: function (data) {//请求成功之后的操作
                //console.log("success");
                var dataMap = JSON.parse(data);
                if ('0' !== dataMap.code) {
                    alert(dataMap.errMsg);
                    window.location.href = "/piflow-web/process/getProcessById?processId=" + dataMap.processId;
                } else {
                    alert("启动失败");
                    startFlow.show();
                    fullScreen.hide();
                }

            }
        });
    }

    //停止
    function stopProcess() {
        stopFlow.hide();
        fullScreen.show();
        $.ajax({
            cache: true,//保留缓存数据
            type: "POST",//为post请求
            url: "/piflow-web/process/stopProcess",//这是我在后台接受数据的文件名
            //data:$('#loginForm').serialize(),//将该表单序列化
            data: {
                flowId: appId
            },
            async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
            error: function (request) {//请求失败之后的操作
                stopFlow.show();
                alert("请求失败");
                fullScreen.hide();
                return;
            },
            success: function (data) {//请求成功之后的操作
                //console.log("success");
                var dataMap = JSON.parse(data);
                if ('0' !== dataMap.code) {
                    alert(dataMap.errorMsg);
                    startFlow.show();
                } else {
                    alert("停止失败" + dataMap.errMsg);
                    stopFlow.show();
                }
                fullScreen.hide();
            }
        });
    }

    function getLogUrl() {
        //appId = "application_1539850523117_0152";
        $.ajax({
            cache: true,//保留缓存数据
            type: "POST",//为post请求
            url: "/piflow-web/process/getLogUrl",//这是我在后台接受数据的文件名
            //data:$('#loginForm').serialize(),//将该表单序列化
            data: {"appId": appId},
            async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
            error: function (request) {//请求失败之后的操作
                return;
            },
            success: function (data) {//请求成功之后的操作
                console.log("success");
                if ('0' !== data.code) {
                    stdoutLog = data.stdoutLog;
                    stderrLog = data.stderrLog;
                    changeUrl(1);
                }
                //alert(data);
            }
        });
    }

    function changeUrl(key) {
        var url
        switch (key) {
            case 1:
                url = stdoutLog;
                break;
            case 2:
                url = stderrLog;
                break;
            default:
                break;
        }
        $.ajax({
            cache: true,//保留缓存数据
            type: "POST",//为post请求
            url: "/piflow-web/process/getLog",//这是我在后台接受数据的文件名
            //data:$('#loginForm').serialize(),//将该表单序列化
            data: {url: url},
            async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
            error: function (request) {//请求失败之后的操作
                return;
            },
            success: function (data) {//请求成功之后的操作
                console.log("success");
                if ('' !== data) {
                    var split0 = data.split('<td class="content">');
                    var data0 = split0[1];
                    var split2 = data0.split("</td>");
                    var data2 = split2[0];
                    "white-space: pre-line;"
                    data2 = data2.replace("<pre>", '<pre style="white-space: pre-wrap; height: 288px;">');
                    //document.getElementById("logTitle").innerHTML = "<h1>"+data1+"</h1>";
                    document.getElementById("customContent").innerHTML = "<div>" + data2 + "</div>";
                }
                //alert(data);
            }
        });
    }

    function processMonitoring(appId) {
        if (appId === '') {
            return;
        }
        $.ajax({
            cache: true,
            type: "get",
            url: "/piflow-web/process/getAppInfo",
            data: {appid: appId},
            async: true,
            traditional: true,
            error: function (request) {
                console.log("error");
                return;
            },
            success: function (data) {
                var dataMap = JSON.parse(data);
                if ("0" !== dataMap.code) {
                    if (dataMap.state && "" !== dataMap.state) {
                        if ('STARTED' !== dataMap.state) {
                            window.clearInterval(timer);
                            startFlow.show();
                            stopFlow.hide();
                        }
                    }
                    var processVo = dataMap.processVo;
                    if (processVo && '' != processVo) {
                        $("#progress").html(dataMap.progress + "%");
                        $("#processStartTimeShow").html(processVo.startTime);
                        $("#processStopTimeShow").html(processVo.endTime);
                        $("#processStateShow").html(dataMap.state);
                        $("#processProgressShow").html(dataMap.progress + "%");
                        // stop
                        var processStopVoList = processVo.processStopVoList;
                        if (processStopVoList && '' != processStopVoList) {
                            for (var i = 0; i < processStopVoList.length; i++) {
                                var processStopVo = processStopVoList[i];
                                if (processStopVo && '' != processStopVo) {
                                    var sotpNameDB = processStopVo.name;
                                    var sotpNameVal = $("#sotpNameShow").text();
                                    if (sotpNameDB === sotpNameVal) {
                                        $("#stopStartTimeShow").html(processStopVo.startTime);
                                        $("#stopStopTimeShow").html(processStopVo.endTime);
                                        $("#stopStateShow").html(processStopVo.state);
                                    }
                                    var pageId = processStopVo.pageId;
                                    var processStopVoState = processStopVo.state;
                                    monitor(pageId, processStopVoState)
                                }
                            }
                        }
                    }
                }
            }
        });
    }

    function monitor(pageId, processStopVoState) {
        var stopFailShow = $("#stopFailShow" + pageId);
        var stopOkShow = $("#stopOkShow" + pageId);
        var stopLoadingShow = $("#stopLoadingShow" + pageId);
        if (processStopVoState && (processStopVoState === "STARTED")) {
            stopFailShow.hide();
            stopOkShow.hide();
            stopLoadingShow.show();
        } else if (processStopVoState && processStopVoState === "COMPLETED") {
            stopFailShow.hide();
            stopLoadingShow.hide();
            stopOkShow.show();
        } else if (processStopVoState && processStopVoState === "FAILED") {
            stopOkShow.hide();
            stopLoadingShow.hide();
            stopFailShow.show();
        }
    }

    //@ sourceURL=processContent.js
</script>
</body>
</html>
