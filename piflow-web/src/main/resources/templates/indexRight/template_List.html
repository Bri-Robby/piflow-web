<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<body th:fragment=template_List>
    <meta th:include="/Macro/csrfTokeHeadMacro :: csrfTokeHeadMacro"/>
    <style type="text/css">
        /*人为制造一个占据整个屏幕的Div,其透明度为0.7且z-index为9999使之前的页面被压在底层无法点击*/
        .fullScreenList {
            position: fixed;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            opacity: 0.7;
            background-color: black;
            z-index: 9999;
            text-align: center;
        }
    </style>
    <script th:src="@{/charisma/js/layer/layer.js}"></script>
    <!-- content starts -->
    <div class="wrapper" style="margin: 20px;">
        <h5 class="widget-name"><i class="icon-th"></i>Template List</h5>
        <!-- Media datatable -->
        <div class="widget">
            <div class="navbar">
                <div class="navbar-inner">
                    <h6>Template List</h6>
                </div>
            </div>
            <div class="navbar">
                <form id="uploadForm" enctype="multipart/form-data" method="post">
                    <input type="file" id="templateFile" name="templateFile" style="display:none;" onchange="importFile()"/>
                    <a class='btn' href='javascript:void(0);' th:onclick="'javascript:uploadTemplate();'"  style='background-color: #C0C0C0;border: 1px solid;color: #080808;' title="upload template">
                        <i class="icon-upload icon-white"></i></a>
                </form>
            </div>
            <div class="table-overflow">
                <table class="table table-striped table-bordered table-checks media-table">
                    <thead>
                    <tr>
                        <th style="display: none">sort</th>
                        <th style="display: none">flowId</th>
                        <th style="display: none">templateId</th>
                        <th>flowName</th>
                        <th>templateName</th>
                        <th>createTime</th>
                        <th class="actions-column">Actions</th>
                    </tr>
                    </thead>
                    <tbody th:unless="${TemPlateList}">
                    </tbody>
                    <tbody th:if="${TemPlateList}">
                    <tr th:each='list:${TemPlateList}'>
                        <td style="display: none" th:text="${listStat.index}"></td>
                        <td style="display: none" th:text="${list.flow?.id}"></td>
                        <td style="display: none" th:text="${list.id}" ></td>
                        <td class="center" th:text="${list.flow?.name} ? ${list.flow?.name} : 'no flowName'"></td>
                        <td class="center" th:text="${list.name}"></td>
                        <td th:text="${#dates.format(list.crtDttm, 'yyyy-MM-dd HH:mm:ss')}"></td>
                        <td class="center" style="white-space: nowrap;">
                            <a class="btn" href="javascript:void(0);" style="background-color: #C0C0C0;border: 1px solid;color: #6b5555;"
                               th:onclick="'javascript:downloadTemplate(\''+${list.id}+'\');'"
                               title="download template">
                                <i class="icon-download icon-white"></i>
                            </a>
                            <a class="btn" href="javascript:void(0);"
                               style="background-color: #C0C0C0;border: 1px solid;color: #6b5555;"
                               th:onclick="'javascript:deleteTemPlate(\''+${list.id}+'\',\''+${list.name}+'\');'"
                               title="delete template" >
                                <i class="icon-trash icon-white"></i>
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- /media datatable -->
    </div>
    <!-- content ends -->
    <div id='fullScreenList' class="fullScreenList" style="display: none;">
        <div style="margin-top: 15%;">
            <p>
                <img th:src="@{/img/fullScreen.gif}" alt="">
            </p>
        </div>
    </div>
    <script th:include="/Macro/csrfTokeHeadMacroScript :: csrfTokeHeadMacroScript"/>
    <script th:inline="javascript">
        function deleteTemPlate(id, name) {
            layer.confirm("Are you sure to delete '" + name + "' ?", {
                btn: ['confirm','cancel'] //按钮
                ,title: 'Confirmation prompt'
            }, function(){
                $.ajax({
                    cache: true,//保留缓存数据
                    type: "get",//为post请求
                    url: "/piflow-web/template/deleteTemplate",//这是我在后台接受数据的文件名
                    data: {id: id},
                    async: true,//设置成true，这标志着在请求开始后，其他代码依然能够执行。如果把这个选项设置成false，这意味着所有的请求都不再是异步的了，这也会导致浏览器被锁死
                    error: function (request) {//请求失败之后的操作
                        return;
                    },
                    success: function (data) {//请求成功之后的操作
                        if (data > 0) {
                            layer.msg('Delete Success', {icon: 1, shade: 0, time: 2000}, function () {
                                location.reload();
                            });
                        } else {
                            layer.msg('Delete failed', {icon: 2, shade: 0, time: 2000}, function () {});
                        }
                    }
                });
            }, function(){});
        }
        function initAll(url) {
            window.location.href = url;
        }

        function uploadTemplate(){
            document.getElementById("templateFile").click();
        }

        function importFile(){
            if(!FileTypeCheck()) {
                return false;
            }
            var formData = new FormData($('#uploadForm')[0]);
            $.ajax({
                type: 'post',
                url: "/piflow-web/template/upload",
                data: formData,
                cache: false,
                processData: false,
                contentType: false,
            }).success(function (data) {
                var dataMap = JSON.parse(data);
                if (0 !== dataMap.code) {
                    layer.msg(dataMap.errMsg, {icon: 1, shade: 0, time: 2000}, function () {  location.reload();});
                }else{
                    layer.msg(dataMap.errMsg, {icon: 2, shade: 0, time: 2000}, function () {});
                }
            }).error(function () {
                layer.msg("Upload failure", {icon: 2, shade: 0, time: 2000}, function () {});
            });
        }

        function FileTypeCheck()
        {
            var obj =document.getElementById('templateFile');
            if(obj.value==null || obj.value ==''){
                layer.msg('please upload the XML file', {icon: 2, shade: 0, time: 2000}, function () {});
                this.focus()
                return false;
            }
            var length = obj.value.length;
            var charindex = obj.value.lastIndexOf(".");
            var ExtentName = obj.value.substring(charindex,charindex+4);
            if(!(ExtentName == ".xml" )){
                layer.msg('please upload the XML file', {icon: 2, shade: 0, time: 2000}, function () {});
                this.focus()
                return false;
            }
            return true;
        }

        function downloadTemplate(id){
            window.location.href = "/piflow-web/template/templateDownload?templateId="+id;
        }
        //@ sourceURL=template_List.js
    </script>
</body>
</html>